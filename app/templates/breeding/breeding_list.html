{% extends 'base.html' %}

{% block title %}Breeding Records{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4 text-success">üêÆ Breeding Records</h2>

    <!-- ‚úÖ Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- ‚úÖ Add Breeding Button (Admins only) -->
    {% if current_user.role == 'admin' %}
    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBreedingModal">
            ‚ûï Add Breeding
        </button>
    </div>
    {% endif %}

    <!-- üìã Breeding Records Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Tag Number</th>
                    <th>Breeding Date</th>
                    <th>Method</th>
                    <th>Attempt #</th>
                    <th>Steaming Date</th>
                    <th>Expected Calving Date</th>
                    <th>Outcome</th>
                    <th>Pregnancy Result</th>
                    <th>Notes</th>
                    <th>Remark</th>
                    <th>Recorded By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ record.tag_number }}</td>
                    <td>{{ record.breeding_date }}</td>
                    <td>{{ record.method }}</td>
                    <td>{{ record.breeding_attempt_number }}</td>
                    <td>{{ record.steaming_date or '-' }}</td>
                    <td>{{ record.expected_calving_date or '-' }}</td>
                    <td>
                        {% if record.breeding_outcome %}
                            <span class="badge bg-info">{{ record.breeding_outcome }}</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>{{ record.pregnancy_test_result or '-' }}</td>
                    <td>{{ record.notes or '-' }}</td>
                    <td>{{ record.remark or '-' }}</td>
                    <td>{{ record.recorder or '-' }}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#editBreedingModal{{ record.id }}">Edit</button>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#pregnancyModal{{ record.id }}">Pregnancy</button>
                    </td>
                </tr>

                <!-- üõ† Edit Breeding Modal -->
                <div class="modal fade" id="editBreedingModal{{ record.id }}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <form method="POST" action="{{ url_for('breeding.edit_breeding', id=record.id) }}">
                            {{ csrf_token() }}
                            <div class="modal-content">
                                <div class="modal-header bg-warning">
                                    <h5 class="modal-title">Edit Breeding - {{ record.tag_number }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body row g-3">
                                    <div class="col-md-6">
                                        <label>Cattle</label>
                                        <select name="cattle_id" class="form-select" required>
                                            {% for cattle in cattle_list %}
                                                <option value="{{ cattle.id }}" {% if cattle.id == record.cattle_id %}selected{% endif %}>
                                                    {{ cattle.tag_number }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Method</label>
                                        <select name="method" class="form-select" onchange="toggleAIFields(this)" required>
                                            <option value="AI" {% if record.method == 'AI' %}selected{% endif %}>AI</option>
                                            <option value="Natural" {% if record.method == 'Natural' %}selected{% endif %}>Natural</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Breeding Date</label>
                                        <input type="date" name="breeding_date" value="{{ record.breeding_date }}" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label>Attempt Number</label>
                                        <input type="number" name="breeding_attempt_number" value="{{ record.breeding_attempt_number }}" class="form-control" required>
                                    </div>

                                    <!-- AI Fields -->
                                    <div class="col-md-4 ai-field">
                                        <label>Semen Type</label>
                                        <input type="text" name="semen_type" value="{{ record.semen_type or '' }}" class="form-control">
                                    </div>
                                    <div class="col-md-4 ai-field">
                                        <label>Semen Price</label>
                                        <input type="number" step="0.01" name="semen_price" value="{{ record.semen_price or '' }}" class="form-control">
                                    </div>
                                    <div class="col-md-4 ai-field">
                                        <label>Sire Name</label>
                                        <input type="text" name="sire_name" value="{{ record.sire_name or '' }}" class="form-control">
                                    </div>

                                    <div class="col-md-6">
                                        <label>Steaming Date</label>
                                        <input type="date" name="steaming_date" value="{{ record.steaming_date or '' }}" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label>Expected Calving Date</label>
                                        <input type="date" name="expected_calving_date" value="{{ record.expected_calving_date or '' }}" class="form-control">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Save</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ü§∞ Pregnancy Modal -->
                <div class="modal fade" id="pregnancyModal{{ record.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <form method="POST" action="{{ url_for('breeding.update_pregnancy', id=record.id) }}">
                            {{ csrf_token() }}
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title">Update Pregnancy - {{ record.tag_number }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <label>Pregnancy Test Result</label>
                                    <select name="pregnancy_test_result" class="form-select" required>
                                        <option value="">-- Select --</option>
                                        <option value="Confirmed" {% if record.pregnancy_test_result == 'Confirmed' %}selected{% endif %}>Confirmed</option>
                                        <option value="Failed" {% if record.pregnancy_test_result == 'Failed' %}selected{% endif %}>Failed</option>
                                    </select>
                                    <label class="mt-3">Notes</label>
                                    <textarea name="notes" class="form-control">{{ record.notes or '' }}</textarea>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-success">Update</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ‚ûï Add Breeding Modal -->
<div class="modal fade" id="addBreedingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form method="POST" action="{{ url_for('breeding.breeding_list') }}">
            {{ csrf_token() }}
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Add Breeding Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row g-3">
                    <div class="col-md-6">
                        <label>Cattle</label>
                        <select name="cattle_id" class="form-select" required>
                            {% for cattle in cattle_list %}
                                <option value="{{ cattle.id }}">{{ cattle.tag_number }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>Method</label>
                        <select name="method" class="form-select" onchange="toggleAIFields(this)" required>
                            <option value="AI">AI</option>
                            <option value="Natural">Natural</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>Breeding Date</label>
                        <input type="date" name="breeding_date" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                        <label>Attempt Number</label>
                        <input type="number" name="breeding_attempt_number" class="form-control" required>
                    </div>

                    <!-- AI Fields -->
                    <div class="col-md-4 ai-field">
                        <label>Semen Type</label>
                        <input type="text" name="semen_type" class="form-control">
                    </div>
                    <div class="col-md-4 ai-field">
                        <label>Semen Price</label>
                        <input type="number" step="0.01" name="semen_price" class="form-control">
                    </div>
                    <div class="col-md-4 ai-field">
                        <label>Sire Name</label>
                        <input type="text" name="sire_name" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label>Steaming Date</label>
                        <input type="date" name="steaming_date" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label>Expected Calving Date</label>
                        <input type="date" name="expected_calving_date" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Add</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript to toggle AI fields -->
<script>
    function toggleAIFields(select) {
        const fields = document.querySelectorAll('.ai-field');
        fields.forEach(field => {
            field.style.display = (select.value === 'AI') ? 'block' : 'none';
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('select[name="method"]').forEach(select => {
            toggleAIFields(select);
        });
    });
</script>
{% endblock %}
