{% extends 'base.html' %}

{% block title %}Add Cattle - Nyanyakwa Dairy Farm{% endblock %}

{% block content %}
<h1 style="text-align: center; color: #2e7d32;">➕ Add New Cattle</h1>

<!-- ✅ Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div style="max-width: 600px; margin: auto;">
      {% for category, message in messages %}
        <div style="
          padding: 10px; 
          margin-bottom: 10px; 
          border: 1px solid #ccc; 
          border-left: 5px solid 
            {% if category == 'success' %}green
            {% elif category == 'danger' %}red
            {% elif category == 'warning' %}orange
            {% else %}gray{% endif %};
          background: #f9f9f9;">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- 🐄 Add Cattle Form -->
<form method="post" style="max-width: 600px; margin: auto;" id="cattleForm">
    {{ csrf_token() }}

    <label for="name">Cattle Name:</label>
    <input type="text" name="name" required style="width: 100%; padding: 8px; margin-bottom: 12px;">

    <label for="breed">Breed:</label>
    <input type="text" name="breed" style="width: 100%; padding: 8px; margin-bottom: 12px;">

    <label for="birth_date">Birth Date:</label>
    <input type="date" name="birth_date" id="birth_date" required style="width: 100%; padding: 8px; margin-bottom: 12px;">

    <label for="sex">Sex:</label>
    <select name="sex" id="sex" required style="width: 100%; padding: 8px; margin-bottom: 12px;">
        <option value="">Select Sex</option>
        <option value="M">Male</option>
        <option value="F">Female</option>
    </select>

    <!-- ⛳ Female 11+ months prompt -->
    <div id="statusPrompt" style="display: none; border: 1px solid #ccc; padding: 12px; background: #f4f4f4; border-radius: 6px; margin-bottom: 12px;">
        <p style="color: #2e7d32; font-weight: bold;">This female is 11 months or older. Please choose status category and status:</p>

        <label>Status Category:</label><br>
        <input type="radio" name="status_category" value="young_stock" checked> Young Stock (Bullying Heifer)<br>
        <input type="radio" name="status_category" value="mature_stock"> Mature Stock (Choose Status)<br><br>

        <div id="matureStatusSelect" style="display: none;">
            <label for="status">Status:</label>
            <select name="status" style="width: 100%; padding: 8px; margin-top: 4px;">
                <option value="">Select Status</option>
                <option value="lactating">Lactating</option>
                <option value="lactating in_calf">Lactating In Calf</option>
                <option value="dry">Dry</option>
            </select>
        </div>
    </div>

    <button type="submit" style="padding: 10px 20px; background-color: #2e7d32; color: white; border: none; border-radius: 5px;">
        ➕ Add Cattle
    </button>
</form>

<!-- 🧠 Age-based Status Logic -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const birthInput = document.getElementById('birth_date');
    const sexInput = document.getElementById('sex');
    const statusPrompt = document.getElementById('statusPrompt');
    const matureStatusSelect = document.getElementById('matureStatusSelect');
    const statusRadios = document.getElementsByName('status_category');

    function getAgeInMonths(dob) {
        const today = new Date();
        const birthDate = new Date(dob);
        let age = (today.getFullYear() - birthDate.getFullYear()) * 12;
        age += today.getMonth() - birthDate.getMonth();
        if (today.getDate() < birthDate.getDate()) age -= 1;
        return age;
    }

    function checkDisplayPrompt() {
        const dob = birthInput.value;
        const sex = sexInput.value;

        if (dob && sex === 'F') {
            const ageInMonths = getAgeInMonths(dob);
            if (ageInMonths >= 11) {
                statusPrompt.style.display = 'block';
            } else {
                statusPrompt.style.display = 'none';
                matureStatusSelect.style.display = 'none';
            }
        } else {
            statusPrompt.style.display = 'none';
            matureStatusSelect.style.display = 'none';
        }
    }

    // Show/hide mature status dropdown based on selected category
    statusRadios.forEach(radio => {
        radio.addEventListener('change', function () {
            matureStatusSelect.style.display = this.value === 'mature_stock' ? 'block' : 'none';
        });
    });

    birthInput.addEventListener('change', checkDisplayPrompt);
    sexInput.addEventListener('change', checkDisplayPrompt);
});
</script>
{% endblock %}
