{% extends 'base.html' %}

{% block title %}Cattle List - Nyanyakwa Dairy{% endblock %}

{% block content %}
<h2 style="text-align: center; color: #2e7d32;">🐄 Cattle List</h2>

<!-- 🔍 Filters -->
<form method="get" class="filter-form" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
  <input type="text" name="search" placeholder="Search..." value="{{ request.args.get('search', '') }}">
  <select name="sex">
    <option value="">Sex</option>
    <option value="male" {% if request.args.get('sex') == 'male' %}selected{% endif %}>Male</option>
    <option value="female" {% if request.args.get('sex') == 'female' %}selected{% endif %}>Female</option>
  </select>
  <select name="status_category">
    <option value="">Category</option>
    <option value="young_stock" {% if request.args.get('status_category') == 'young_stock' %}selected{% endif %}>Young Stock</option>
    <option value="mature_stock" {% if request.args.get('status_category') == 'mature_stock' %}selected{% endif %}>Mature Stock</option>
  </select>
  <button type="submit">🔍 Filter</button>
  <button type="button" onclick="document.getElementById('addModal').style.display='block'" style="margin-left:auto;">➕ Add Cattle</button>
</form>

<!-- 🐄 Cattle Table -->
<form method="post" action="{{ url_for('cattle.archive_cattle') }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <table border="1" cellpadding="8" cellspacing="0" width="100%">
    <thead>
      <tr>
        <th>Tag</th>
        <th>Name</th>
        <th>Breed</th>
        <th>Sex</th>
        <th>Birth Date</th>
        <th>Status Category & Status</th>
        <th>Remark</th>
        {% if session.get('role') == 'admin' %}<th>Actions</th>{% endif %}
      </tr>
    </thead>
    <tbody>
      {% for c in cattle %}
      <tr>
        <td>{{ c.tag_number }}</td>
        <td>{{ c.name or '-' }}</td>
        <td>{{ c.breed or '-' }}</td>
        <td>{{ c.sex.title() }}</td>
        <td>{{ c.birth_date }}</td>
        <td>{{ c.status_category }} - {{ c.status }}</td>
        <td>{{ c.remark }}</td>
        {% if session.get('role') == 'admin' %}
        <td>
          <a href="{{ url_for('cattle.edit_cattle', cattle_id=c.cattle_id) }}">✏️</a>
          <a href="{{ url_for('cattle.delete_cattle', cattle_id=c.cattle_id) }}">🗑️</a>
          <button type="submit" name="cattle_id" value="{{ c.cattle_id }}" onclick="return confirm('Archive this record?')">📦</button>
          <input type="hidden" name="remark" value="archived">
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>

<!-- Pagination -->
<div style="margin-top: 20px; text-align: center;">
  {% if total_pages > 1 %}
    {% for page_num in range(1, total_pages + 1) %}
      {% if page_num == current_page %}
        <strong>{{ page_num }}</strong>
      {% else %}
        <a href="?page={{ page_num }}">{{ page_num }}</a>
      {% endif %}
    {% endfor %}
  {% endif %}
</div>

<!-- ➕ Add Cattle Modal -->
<div id="addModal" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4);">
  <div style="background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 600px; position: relative;">
    <span onclick="document.getElementById('addModal').style.display='none'" style="position: absolute; top: 10px; right: 20px; cursor: pointer; font-size: 20px;">&times;</span>
    <h3>Add New Cattle</h3>
    <form method="post" action="{{ url_for('cattle.add_cattle') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      
      <label>Name:</label>
      <input type="text" name="name" required><br>
      
      <label>Breed:</label>
      <input type="text" name="breed"><br>
      
      <label>Birth Date:</label>
      <input type="date" name="birth_date" required><br>
      
      <label>Sex:</label>
      <select name="sex" required>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select><br>
      
      <label>Remark:</label>
      <select name="remark">
        <option value="active" selected>Active</option>
        <option value="sold">Sold</option>
        <option value="dead">Dead</option>
        <option value="archived">Archived</option>
      </select><br>

      <!-- Age-Based Status Fields -->
      <div id="statusPrompt" style="display: none; margin-top:10px;">
        <label>Status Category:</label><br>
        <input type="radio" name="status_category" value="young_stock" checked> Young Stock<br>
        <input type="radio" name="status_category" value="mature_stock"> Mature Stock<br>

        <div id="matureStatusSelect" style="display: none; margin-top:5px;">
          <label>Status:</label>
          <select name="status">
            <option value="">-- Select Status --</option>
            <option value="lactating">Lactating</option>
            <option value="lactating in_calf">Lactating In Calf</option>
            <option value="dry">Dry</option>
            <option value="in_calf heifer">In Calf Heifer</option>
          </select>
        </div>
      </div>

      <button type="submit" style="margin-top:10px;">Add Cattle</button>
    </form>
  </div>
</div>

<!-- Scripts -->
<script>
  // Calculate age in full months between birth date and today
  function calculateAgeInMonths(birthDateStr) {
    const today = new Date();
    const birthDate = new Date(birthDateStr);
    let months = (today.getFullYear() - birthDate.getFullYear()) * 12;
    months -= birthDate.getMonth();
    months += today.getMonth();
    return Math.max(0, months); // Ensure non-negative
  }

  // Show/hide status prompts based on sex and age
  function updateStatusFields() {
    const sexInput = document.querySelector('select[name="sex"]');
    const birthDateInput = document.querySelector('input[name="birth_date"]');
    const statusPrompt = document.getElementById('statusPrompt');
    const matureStatusSelect = document.getElementById('matureStatusSelect');

    const sex = sexInput?.value.trim().toLowerCase();
    const birthDate = birthDateInput?.value;

    if (sex === 'female' && birthDate) {
      const ageMonths = calculateAgeInMonths(birthDate);
      if (ageMonths >= 11) {
        statusPrompt.style.display = 'block';
      } else {
        statusPrompt.style.display = 'none';
        matureStatusSelect.style.display = 'none';
      }
    } else {
      statusPrompt.style.display = 'none';
      matureStatusSelect.style.display = 'none';
    }
  }

  // Wait for the DOM to be fully loaded before attaching listeners
  document.addEventListener('DOMContentLoaded', function () {
    const birthDateInput = document.querySelector('input[name="birth_date"]');
    const sexInput = document.querySelector('select[name="sex"]');
    const statusRadios = document.querySelectorAll('input[name="status_category"]');
    const matureStatusSelect = document.getElementById('matureStatusSelect');

    birthDateInput?.addEventListener('change', updateStatusFields);
    sexInput?.addEventListener('change', updateStatusFields);

    statusRadios.forEach(radio => {
      radio.addEventListener('change', function () {
        if (this.value === 'mature_stock') {
          matureStatusSelect.style.display = 'block';
        } else {
          matureStatusSelect.style.display = 'none';
        }
      });
    });
  });
</script>

// Modal close outside click
window.onclick = function(event) {
  const modal = document.getElementById('addModal');
  if (event.target == modal) modal.style.display = "none";
};
</script>

{% endblock %}
