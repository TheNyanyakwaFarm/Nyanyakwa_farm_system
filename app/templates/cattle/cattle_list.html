{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h2>Cattle List</h2>

  <div class="text-start my-2">
    <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary">
      ← Back_to_dashboard
    </a>
  </div>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Add Cattle Button -->
  <button type="button" class="btn btn-primary my-3" data-bs-toggle="modal" data-bs-target="#addCattleModal">
    + Add Cattle
  </button>

  <!-- Cattle Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Cattle ID</th>
		  <th>Tag Number</th> 
          <th>Name</th>
          <th>Sex</th>
          <th>Breed</th>
          <th>Birth Date</th>
          <th>Age</th>
          <th>Status</th>
          <th>Status Category</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for cattle in cattle_list %}
          <tr>
		    <td>{{ cattle.cattle_id }}</td>
            <td>{{ cattle.tag_number }}</td>
            <td>{{ cattle.name }}</td>
            <td>{{ cattle.sex }}</td>
            <td>{{ cattle.breed }}</td>
            <td>{{ cattle.birth_date.strftime('%Y-%m-%d') if cattle.birth_date else '' }}</td>
            <td>{{ cattle.age_in_months }} months</td>
            <td>{{ cattle.status or '—' }}</td>
            <td>{{ cattle.status_category or '—' }}</td>
            <td>
              <!-- Edit/Delete Buttons (You can link modals here too) -->
              <a href="{{ url_for('cattle.edit_cattle', cattle_id=cattle.id) }}" class="btn btn-sm btn-warning">Edit</a>
              <a href="{{ url_for('cattle.delete_cattle', cattle_id=cattle.id) }}" class="btn btn-sm btn-danger">Delete</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add Cattle Modal -->
<div class="modal fade" id="addCattleModal" tabindex="-1" aria-labelledby="addCattleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form action="{{ url_for('cattle.add_cattle') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="addCattleModalLabel">Add New Cattle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body row g-3">

          <div class="col-md-6">
            <label>Name</label>
            <input type="text" class="form-control" name="name">
          </div>

          <div class="col-md-6">
            <label>Sex</label>
            <select name="sex" class="form-select" required>
              <option value="">-- Select --</option>
              <option value="female">Female</option>
              <option value="male">Male</option>
            </select>
          </div>

          <div class="col-md-6">
            <label>Breed</label>
            <input type="text" class="form-control" name="breed">
          </div>

          <div class="col-md-6">
            <label>Birth Date</label>
            <input type="date" class="form-control" name="birth_date" required>
          </div>

          <!-- Age-Based Status Fields (shown only for female) -->
          <div class="col-12" id="statusPromptWrapper" style="display: none; margin-top: 10px;">
            <div id="statusPrompt" style="color: #2e7d32; font-style: italic; margin-bottom: 5px;">
              This female is 11 months or older. Please choose status category and status
            </div>

            <label>Status Category:</label><br>
            <input type="radio" name="status_category" value="young_stock" checked> Young Stock<br>
            <input type="radio" name="status_category" value="mature_stock"> Mature Stock<br>

            <div id="matureStatusSelect" style="display: none; margin-top: 5px;">
              <label>Status:</label>
              <select name="status" class="form-select">
                <option value="">-- Select Status --</option>
                <option value="lactating">Lactating</option>
                <option value="lactating in_calf">Lactating In Calf</option>
                <option value="dry">Dry</option>
                <option value="in_calf heifer">In Calf Heifer</option>
              </select>
            </div>
          </div>

          <div class="col-12">
            <label>Notes</label>
            <textarea class="form-control" name="notes" rows="2"></textarea>
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS to control age/status logic -->
<script>
  function calculateAgeInMonths(birthDate) {
    const birth = new Date(birthDate);
    const today = new Date();
    let months = (today.getFullYear() - birth.getFullYear()) * 12;
    months += today.getMonth() - birth.getMonth();
    if (today.getDate() < birth.getDate()) {
      months--;
    }
    return months;
  }

  function updateStatusFields() {
    const sexInput = document.querySelector('select[name="sex"]');
    const birthDateInput = document.querySelector('input[name="birth_date"]');
    const statusPromptWrapper = document.getElementById('statusPromptWrapper');
    const statusPrompt = document.getElementById('statusPrompt');

    const sex = sexInput?.value.trim().toLowerCase();
    const birthDate = birthDateInput?.value;

    if (sex === 'female') {
      statusPromptWrapper.style.display = 'block';

      if (birthDate) {
        const ageMonths = calculateAgeInMonths(birthDate);
        if (ageMonths >= 11) {
          statusPrompt.style.display = 'block';
        } else {
          statusPrompt.style.display = 'none';
        }
      } else {
        statusPrompt.style.display = 'none';
      }
    } else {
      statusPromptWrapper.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const birthDateInput = document.querySelector('input[name="birth_date"]');
    const sexInput = document.querySelector('select[name="sex"]');
    const statusRadios = document.querySelectorAll('input[name="status_category"]');
    const matureStatusSelect = document.getElementById('matureStatusSelect');

    birthDateInput?.addEventListener('change', updateStatusFields);
    sexInput?.addEventListener('change', updateStatusFields);

    statusRadios.forEach(radio => {
      radio.addEventListener('change', function () {
        matureStatusSelect.style.display = this.value === 'mature_stock' ? 'block' : 'none';
      });
    });

    updateStatusFields(); // Run on initial load
  });
</script>
{% endblock %}
