{% extends 'base.html' %}

{% block title %}Edit Cattle - Nyanyakwa Dairy Farm{% endblock %}

{% block content %}
<h1 style="text-align: center; color: #2e7d32;">‚úèÔ∏è Edit Cattle Record</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div style="max-width: 600px; margin: auto;">
      {% for category, message in messages %}
        <div style="padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-left: 5px solid 
          {% if category == 'success' %}green
          {% elif category == 'danger' %}red
          {% elif category == 'warning' %}orange
          {% else %}gray{% endif %}; background: #f9f9f9;">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<form method="post" style="max-width: 600px; margin: auto;" id="editCattleForm">
    {{ csrf_token() }}

    <label>Name:</label>
    <input type="text" name="name" value="{{ cattle.name }}" required><br><br>

    <label>Breed:</label>
    <input type="text" name="breed" value="{{ cattle.breed }}"><br><br>

    <label>Birth Date:</label>
    <input type="date" name="birth_date" id="birth_date" value="{{ cattle.birth_date }}" required><br><br>

    <label>Sex:</label>
    <select name="sex" id="sex" required>
        <option value="M" {% if cattle.sex == 'M' %}selected{% endif %}>Male</option>
        <option value="F" {% if cattle.sex == 'F' %}selected{% endif %}>Female</option>
    </select><br><br>

    <!-- üìå Status logic: shown if female and 12+ months -->
    <div id="statusPrompt" style="display: none; border: 1px solid #ccc; padding: 10px; background: #f4f4f4; border-radius: 6px;">
        <p style="color: #2e7d32; font-weight: bold;">This female is 12 months or older. Please choose category and status below:</p>

        <label>Status Category:</label><br>
        <input type="radio" name="status_category" value="young_stock"
            {% if cattle.status_category == 'young_stock' %}checked{% endif %}> Young Stock (Bullying Heifer)<br>
        <input type="radio" name="status_category" value="mature_stock"
            {% if cattle.status_category == 'mature_stock' %}checked{% endif %}> Mature Stock (Choose Status)<br><br>

        <div id="matureStatusSelect" style="display: none;">
            <label>Status:</label>
            <select name="status">
                <option value="">Select Status</option>
                <option value="lactating" {% if cattle.status == 'lactating' %}selected{% endif %}>Lactating</option>
                <option value="lactating in_calf" {% if cattle.status == 'lactating in_calf' %}selected{% endif %}>Lactating In Calf</option>
                <option value="dry" {% if cattle.status == 'dry' %}selected{% endif %}>Dry</option>
            </select><br><br>
        </div>
    </div>

    <button type="submit">üíæ Save Changes</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const birthInput = document.getElementById('birth_date');
    const sexInput = document.getElementById('sex');
    const statusPrompt = document.getElementById('statusPrompt');
    const matureStatusSelect = document.getElementById('matureStatusSelect');
    const statusRadios = document.getElementsByName('status_category');

    function getAgeInMonths(dob) {
        const today = new Date();
        const birthDate = new Date(dob);
        let age = (today.getFullYear() - birthDate.getFullYear()) * 12;
        age += today.getMonth() - birthDate.getMonth();
        if (today.getDate() < birthDate.getDate()) age -= 1;
        return age;
    }

    function checkDisplayPrompt() {
        const dob = birthInput.value;
        const sex = sexInput.value;

        if (dob && sex === 'F') {
            const ageInMonths = getAgeInMonths(dob);
            if (ageInMonths >= 12) {
                statusPrompt.style.display = 'block';
                const selected = document.querySelector('input[name="status_category"]:checked');
                if (selected && selected.value === 'mature_stock') {
                    matureStatusSelect.style.display = 'block';
                }
            } else {
                statusPrompt.style.display = 'none';
                matureStatusSelect.style.display = 'none';
            }
        } else {
            statusPrompt.style.display = 'none';
            matureStatusSelect.style.display = 'none';
        }
    }

    statusRadios.forEach(radio => {
        radio.addEventListener('change', function () {
            matureStatusSelect.style.display = this.value === 'mature_stock' ? 'block' : 'none';
        });
    });

    birthInput.addEventListener('change', checkDisplayPrompt);
    sexInput.addEventListener('change', checkDisplayPrompt);
    checkDisplayPrompt();  // Initial check
});
</script>
{% endblock %}
